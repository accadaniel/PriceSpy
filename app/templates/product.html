{% extends "base.html" %}

{% block title %}{{ product.name }} - PriceSpy{% endblock %}

{% block content %}
<a href="/" style="color: #4CAF50; text-decoration: none; display: inline-block; margin-bottom: 20px;">
    &larr; Back to Products
</a>

<div class="card">
    <h2>{{ product.name }}</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
        <div>
            <strong>Search Query:</strong><br>
            {{ product.search_query }}
        </div>
        {% if product.size %}
        <div>
            <strong>Size:</strong><br>
            {{ product.size }}
        </div>
        {% endif %}
        {% if product.color %}
        <div>
            <strong>Color:</strong><br>
            {{ product.color }}
        </div>
        {% endif %}
        <div>
            <strong>Target Price:</strong><br>
            ${{ "%.2f"|format(product.target_price) }}
        </div>
        <div>
            <strong>Status:</strong><br>
            {{ "Active" if product.is_active else "Paused" }}
        </div>
        <div>
            <strong>Alert Email:</strong><br>
            {{ product.user_email }}
        </div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <form action="/product/{{ product.id }}/toggle" method="post">
            <button type="submit" class="btn btn-secondary">
                {{ "Activate" if not product.is_active else "Pause Tracking" }}
            </button>
        </form>
        <form action="/product/{{ product.id }}/delete" method="post"
              onsubmit="return confirm('Delete this product and all its price history?');">
            <button type="submit" class="btn btn-danger">Delete Product</button>
        </form>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="card">
        <h3 style="margin-bottom: 15px;">Current Prices</h3>

        {% if latest_prices %}
        <ul class="price-list">
            {% for price in latest_prices %}
            <li>
                <div>
                    <strong>{{ price.retailer }}</strong>
                    <div style="font-size: 0.85rem; color: #666;">
                        {{ price.scraped_at[:16] if price.scraped_at else '' }}
                    </div>
                </div>
                <div>
                    <span class="price {% if loop.first %}lowest{% endif %}">
                        ${{ "%.2f"|format(price.price) }}
                    </span>
                    {% if price.url %}
                    <a href="{{ price.url }}" target="_blank" style="margin-left: 10px;">Visit</a>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="color: #666;">No prices scraped yet. Prices will be collected on the next scheduled run.</p>
        {% endif %}
    </div>

    <div class="card">
        <h3 style="margin-bottom: 15px;">Price History</h3>

        {% if price_history %}
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="price-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Retailer</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in price_history %}
                    <tr>
                        <td>{{ record.scraped_at[:16] if record.scraped_at else '' }}</td>
                        <td>{{ record.retailer }}</td>
                        <td>
                            ${{ "%.2f"|format(record.price) }}
                            {% if record.url %}
                            <a href="{{ record.url }}" target="_blank" style="font-size: 0.85rem;">link</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: #666;">No price history yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
